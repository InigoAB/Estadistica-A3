---
title: "Estadistica-A3"
author: "Iñigo"
date: "7/12/2020"
output:
  html_document:
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, message=FALSE, warning=FALSE}
# Empiezo cargando los paquetes que usaré:
library(knitr)
library(gridExtra)
library(tidyverse)
library(scales)
```

# 1. Datos y Estadística descriptiva

## 1.1 Lectura de datos
En primer lugar, leed el fichero de datos y verificad que los tipos de datos se interpretan correctamente. Si fuera necesario, haced las oportunas conversiones de tipos.
```{r}
house <- read.csv("house.csv", stringsAsFactors=TRUE, sep=";")
head(house)
str(house)
```

Veo que la variable Sold se ha cargado como de tipo numérico entero y no como factor. La cambio.

```{r}
house$Sold <- ifelse(test=house$Sold == 1, yes="YES", no="NO")
house$Sold <- as.factor(house$Sold)
```

## 1.2. Descriptiva y visualización

A continuación, comenzaremos el estudio descriptivo, para caracterizar el tipo de variables, detectar posible datos faltantes, outliers, variables con varianza nula o casi nula, etc.

```{r}
summary(house)
```

Voy a visualizar los histogramas de las variables.
```{r message=FALSE, warning=FALSE}
grid.arrange(
  qplot(price, data=house),
  qplot(resid_area, data=house),
  qplot(air_qual, data=house),
  qplot(room_num, data=house),
  qplot(age, data=house),
  qplot(dist1, data=house),
  qplot(dist2, data=house),
  qplot(dist3, data=house),
  qplot(dist4, data=house),
  qplot(teachers, data=house),
  qplot(poor_prop, data=house),
  qplot(airport, data=house),
  qplot(n_hos_beds, data=house),
  qplot(n_hot_rooms, data=house),
  qplot(waterbody, data=house),
  qplot(rainfall, data=house),
  qplot(bus_ter, data=house),
  qplot(parks, data=house),
  qplot(Sold, data=house)
)
```

Y diagramas de dispersión respecto al precio.
```{r message=FALSE, warning=FALSE}
grid.arrange(
  qplot(resid_area, price, data=house),
  qplot(air_qual, price, data=house),
  qplot(room_num, price, data=house),
  qplot(age, price, data=house),
  qplot(dist1, price, data=house),
  qplot(dist2, price, data=house),
  qplot(dist3, price, data=house),
  qplot(dist4, price, data=house),
  qplot(teachers, price, data=house),
  qplot(poor_prop, price, data=house),
  qplot(n_hos_beds, price, data=house),
  qplot(n_hot_rooms, price, data=house),
  qplot(rainfall, price, data=house),
  qplot(parks, price, data=house)
)
```

Se intuye una relación lineal entre price y room-num y también entre price y poor_prop (proporción de población pobre en la ciudad). No da la sensación de que haya ningún valor muy aislado.

Voy a mirar con unos diagramas de cajas si hay valores extremos en el precio, separados por si están vendidos o no.
```{r}
ggplot(house, aes(x=Sold, y=price, color=Sold)) + 
  ggtitle("Diagrama de cajas") + 
  scale_color_brewer(palette="Dark2") +
  geom_boxplot()
```

No se ve que haya ningún valor extremo muy apartado del resto, como para quitarlo.

# 2. Modelo de regresión lineal

## 2.1. Modelo de regresión lineal simple

### 2.1.1. Calcular
Estimar por mínimos cuadrados ordinarios dos modelos lineales que expliquen la variable price, uno en función de la variable teachers y otro en función de la variable poor_prop.
```{r}
lm_teachers <- lm(price ~ teachers, data=house)
lm_teachers
```

El modelo de regresión obtenido que explica la variable price en función de teachers es: 
$$\hat{y} =  `r round(lm_teachers$coefficients[1],2)` + `r round(lm_teachers$coefficients[2],2)`x$$

```{r}
lm_poor_prop <- lm(price ~ poor_prop, data=house)
lm_poor_prop
```

El modelo de regresión obtenido que explica la variable price en función de teachers es: 
$$\hat{y} =  `r round(lm_poor_prop$coefficients[1],2)` `r round(lm_poor_prop$coefficients[2],2)`x$$

### 2.1.2. Describe las diferencias entre ambos modelos y compáralos.
Miro el resultado del cálculo de regresión lineal para explicar los precios (price) de las casas con el número de profesores (teachers).
```{r 2.1.2.1}
summary(lm_teachers)
```

Ahora miro el resultado de calcular la regresión lineal para explicar el precio de las casas (price) con la proporción de población pobre en la ciudad (poor_prop).
```{r 2.1.2.2}
summary(lm_poor_prop)
```

Podemos ver que a mayor número de profesores aumenta el precio de las casas mientras que a mayor proporción de pobreza disminuye el precio. Es decir para el primer modelo la pendiente es positiva mientras que para el segundo modelo la pendiente es negativa.

En el primer caso tenemos que tan solo el `r label_percent(accuracy = 0.01)(summary(lm_teachers)$adj.r.squared)` de la varianza de las observaciones queda explicada por el modelo.

El segundo modelo es mejor ya que logra explicar el `r label_percent(accuracy = 0.01)(summary(lm_poor_prop)$adj.r.squared)` de la varianza de las observaciones.

### 2.1.3. Para cada modelo, realiza un gráfico de dispersión XY e interpretar brevemente el gráfico resultante.

```{r 2.1.3.1}
with(house, plot(teachers, price, main="price ~ teachers"))
abline(lm_teachers, col="blue")
```

```{r 2.1.3.2}
with(house, plot(poor_prop, price, main="price ~ poor_prop"))
abline(lm_poor_prop, col="blue")
```

Gráficamente se ven claramente las distintas pendientes pero también se puede confirmar que el primer modelo se ajusta mucho peor a los datos que el segundo. El segundo modelo se puede ver que se ve afectado por los datos más extremos ya que sin ellos se ve una tendencia clara pero más moderada.

## 2.2. Modelo de regresión lineal múltiple (regresores cuantitativos)

### 2.2.1. Calcular

Estimar por mínimos cuadrados ordinarios un modelo lineal que explique la variable price en función de age, teachers, poor_prop.

```{r 2.2.1.}
lm_2.2 <- lm(price ~ age + teachers + poor_prop, data=house)
lm_2.2
```

El modelo de regresión obtenido es: $$\hat{y} =  `r round(lm_2.2$coefficients[1],2)` + `r round(lm_2.2$coefficients[2],2)`x_1 + `r round(lm_2.2$coefficients[3],2)`x_2 `r round(lm_2.2$coefficients[4],2)`x_3$$

### 2.2.2. Indicar el efecto de cada variable regresora e interpretar el modelo.

Intercept es la ordenada en el origen que nos indica el precio en caso de que el resto de variables sean 0. En este caso `r round(lm_2.2$coefficients[1],2)` millones es el precio esperado para una casa construida este mismo año, sin que llegue a haber ni un profesor por cada mil habitantes y sin que haya pobreza.

$x_1$ (age) nos indica que el incremento estimado del precio de las casas será de `r round(lm_2.2$coefficients[2],2)` por cada incremento de un año desde la fecha de construcción.

La variable $x_2$ (teachers) nos dice que el precio de las casas se estima que incrementará en `r round(lm_2.2$coefficients[3],2)` unidades por cada profesor que haya por cada mil habitantes.

La variable $x_3$ (poor_prop) indica que por cada aumento unitario en la proporción de pobreza el precio de las casas disminuirá en `r round(lm_2.2$coefficients[4],2)` unidades.

### 2.2.3. Evaluar la bondad de ajuste a través del coeficiente de determinación ajustado.

```{r 2.2.3.}
summary(lm_2.2)
```

Vemos que el coeficiente de determinación ajustado es r`(summary(lm_2.2)$adj.r.squared)` por lo que el modelo explica el `r label_percent(accuracy = 0.01)(summary(lm_2.2)$adj.r.squared)` de la varianza de las variables. Ha mejorado bastante respecto a los modelos de regresión simple.

### 2.2.4. Ampliar el modelo anterior con las variables room_num, n_hos_beds y n_hot_rooms.

Comparar los dos modelos. ¿Es significativamente mejor el nuevo modelo?

```{r}
lm_2.2.4 <- lm(price ~ age + teachers + poor_prop + room_num + n_hos_beds + n_hot_rooms, data=house)
summary(lm_2.2.4)
```

Veo que este nuevo modelo tiene un coeficiente de determinación ajustado es `r (summary(lm_2.2.4)$adj.r.squared)` por lo que el modelo explica el `r label_percent(accuracy = 0.01)(summary(lm_2.2.4)$adj.r.squared)` de la varianza de las variables. Mientras que el anterior explicaba el `r label_percent(accuracy = 0.01)(summary(lm_2.2)$adj.r.squared)` de la varianza de las variables.

El modelo ha mejorado un `r label_percent(accuracy = 0.01)((summary(lm_2.2.4)$adj.r.squared)-(summary(lm_2.2)$adj.r.squared))`.

```{r}
anova(lm_2.2, lm_2.2.4)
```

## 2.3. Modelo de regresión lineal múltiple (regresores cuantitativos y cualitativos)
Queremos conocer en qué medida el modelo anterior (Modelo 2.2) se ve afectado por la inclusión de la variable airport.

### 2.3.1. Aplicar un modelo de regresión lineal múltiple y explicar el resultado.

```{r}
lm_2.3.1 <- lm(price ~ age + teachers + poor_prop + airport, data=house)
lm_2.3.1
```

El modelo de regresión obtenido es: $$\hat{y} =  `r round(lm_2.3.1$coefficients[1],2)` + `r round(lm_2.3.1$coefficients[2],2)`x_1 + `r round(lm_2.3.1$coefficients[3],2)`x_2 `r round(lm_2.3.1$coefficients[4],2)`x_3 `r round(lm_2.3.1$coefficients[5],2)`x_4$$

La ordenada en el orginen (Intercept) nos indica que el precio estimado de la casa es de `r round(lm_2.3.1$coefficients[1],2)` en caso de que sea de nueva construcción (de este año), sin profesores (ni uno por cada mil habitantes), sin pobreza y sin aeropuerto.

$x_1$ (age) nos indica un incremento estimado en el precio de la casa de `r round(lm_2.3.1$coefficients[2],2)` millones por cada año de antigüedad de la misma (desde la fecha de construcción).

$x_2$ (teachers) indica un incremento estimado en el precio de la casa de `r round(lm_2.3.1$coefficients[3],2)` millones por cada profesor por mil habitantes.

$x_3$ (poor_prop) indica una disminución estimada en el precio de la casa de `r round(lm_2.3.1$coefficients[4],2)` millones por cada aumento unitario en la proporción de pobreza.

$x_4$ (airportYES) indica que se estima que el precio de la casa disminuirá en `r round(lm_2.3.1$coefficients[5],2)` millones en caso de que la ciudad tenga aeropuerto.


### 2.3.2. ¿Es significativamente mejor el nuevo modelo?

```{r}
summary(lm_2.3.1)
```

Veo que este nuevo modelo tiene un coeficiente de determinación ajustado es `r (summary(lm_2.3.1)$adj.r.squared)` por lo que el modelo explica el `r label_percent(accuracy = 0.01)(summary(lm_2.3.1)$adj.r.squared)` de la varianza de las variables. Mientras que el anterior explicaba el `r label_percent(accuracy = 0.01)(summary(lm_2.2)$adj.r.squared)` de la varianza de las variables.

El modelo ha mejorado un `r label_percent(accuracy = 0.01)((summary(lm_2.3.1)$adj.r.squared)-(summary(lm_2.2)$adj.r.squared))`. Por lo que casi no hay diferencia.

```{r}
anova(lm_2.2, lm_2.3.1)
```

Haciendo un análisis de la varianza se puede ver que la inclusión de airport no mejora el modelo.

### 2.3.3. Efectuar una predicción del precio de la vivienda.
Para una vivienda cuyas características son:
age =70, teachers =15 , poor_prop =15, room_num =8, n_hos_beds=8, n_hot_rooms=100 
Utilizar el modelo Model.2.2
```{r}
predicción <- predict(object = lm_2.2,     # The regression model
        newdata = data.frame(age =70, teachers =15 , poor_prop =15, 
                             room_num =8, n_hos_beds=8, n_hot_rooms=100)
        )   # dataframe of new data
predicción
```

El precio previsto para una vivienda con las características dadas sería de `r round(predicción,2)` unidades monetarias.

### 2.3.4. Efectuar una verificación visual de las suposiciones de modelización.
Analiza los residuos del modelo. Comenta los resultados.

```{r}
par(mfrow = c(2, 1))
plot(lm_2.2, which = 1:2)
```

Aunque parece que los residuos mayoritariamente se encuentran en la línea del 0 en la parte dentral en los extremos se tiende a alejar, esto podría indicar problemas de tendencias.

En el gráfico Normal Q-Q se ve como la cola derecha se aleja de la línea normal, lo que nos indica una asimetría en los precios altos.

